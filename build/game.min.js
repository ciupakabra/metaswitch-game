var config={renderer:Phaser.AUTO,width:900,height:600},bootConfig={preload:function(){game.load.spritesheet("button","assets/ui/menu/buttons.png",600,150),game.load.spritesheet("buttonSmall","assets/ui/menu/buttonsSmall.png",250,125),game.load.spritesheet("buttonPause","assets/ui/menu/buttonsPause.png",35,35),game.load.spritesheet("buttonReload","assets/ui/menu/buttonsReload.png",35,35),game.load.spritesheet("buttonSpeed","assets/ui/menu/buttonsSpeed.png",35,35),game.load.image("aboutUs","assets/ui/menu/aboutUs.png"),game.load.image("logo","assets/ui/menu/metaswitch-logo.png"),game.load.image("arrow","assets/ui/menu/arrow.png"),this.load.image("server","assets/server.png"),this.load.image("resource","assets/resource.png"),this.load.image("city","assets/city.png"),game.load.script("webfont","//ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js"),slickUI=game.plugins.add(Phaser.Plugin.SlickUI),game.add.plugin(PhaserInput.Plugin),this.game.scale.pageAlignHorizontally=!0,this.game.scale.pageAlignVertically=!0,this.game.scale.refresh()}},menuConfig={create:function(){function e(e,t,a,o){button=game.add.button(e,t,"button",function(){},this,1,0,1,0),button.onInputDown.add(o,this),(a=game.add.text(e+300,t+75,a)).font="Lato",a.anchor.setTo(.5),a.fontSize=80}game.stage.backgroundColor=1118481,e(150,34,"Play Game",function(){game.state.start("game")}),e(150,218,"Tutorial",function(){tutorialOn=!0,tutorialScreen=0,game.state.start("tutorial")}),e(150,402,"About Us",function(){game.state.start("about")})}},aboutConfig={create:function(){game.stage.backgroundColor=1118481,background=game.add.tileSprite(0,0,900,600,"aboutUs"),button=game.add.button(166,450,"buttonSmall",function(){},this,1,0,1,0),button.onInputDown.add(function(){window.open("https://www.metaswitch.com/careers")},this),text=game.add.text(291,512,"Careers"),text.font="Lato",text.anchor.setTo(.5),text.fontSize=60,button=game.add.button(517,450,"buttonSmall",function(){},this,1,0,1,0),button.onInputDown.add(function(){game.state.start("menu")},this),text=game.add.text(642,512,"Menu"),text.font="Lato",text.anchor.setTo(.5),text.fontSize=60}},submitConfig={create:function(){var e=game.add.text(450,40,e);e.font="Lato",e.anchor.setTo(.5),e.fontSize=40,e.text="Thank You for Playing Net-a-switch, powered by",e.fill="#ffffff";var t=game.add.image(450,100,"logo");t.anchor.setTo(.5),t.scale.setTo(.5);var a=game.add.text(450,230,a);a.font="Lato",a.anchor.setTo(.5),a.fontSize=25,a.text="Metaswitch is a UK-based tech company that designs, develops, manufactures, and markets telecommunications software. Congratulations on your score! If you liked this game, we think you could be a good fit for a career at Metaswitch. Please check out our career page and submit your details below to keep in touch.",a.fill="#ffffff",a.wordWrap=!0,a.wordWrapWidth=800,a.align="center";var o=game.add.inputField(80,330,{font:"30px Lato",fill:"#ffffff",width:355,height:40,placeHolder:"First Name...",padding:10,borderColor:"#505050",backgroundColor:"#111111",cursorColor:"#505050",borderRadius:5,placeHolderColor:"#505050"}),n=game.add.inputField(465,330,{font:"30px Lato",fill:"#ffffff",width:355,height:40,placeHolder:"Last Name...",padding:10,borderColor:"#505050",backgroundColor:"#111111",cursorColor:"#505050",borderRadius:5,placeHolderColor:"#505050"}),r=game.add.inputField(80,400,{font:"30px Lato",fill:"#ffffff",width:740,height:40,placeHolder:"Enter your email address...",padding:10,borderColor:"#505050",backgroundColor:"#111111",cursorColor:"#505050",borderRadius:5,placeHolderColor:"#505050"});function i(e,t,a,o){return button=game.add.button(e,t,"button",function(){},this,1,0,1,0),button.onInputDown.add(o,this),(a=game.add.text(e+90,t+30,a)).font="Lato",a.anchor.setTo(.5),a.fontSize=40,button}button1=i(100,475,"Submit",function(){var e={first:o.text._text,last:n.text._text,email:r.text._text,score:lifetimeCredit,elapsed:totalTime};$.ajax({url:"submit",type:"POST",data:JSON.stringify(e),success:function(){game.state.start("menu"),alert("Your score has successfully been submitted to Metaswitch.")}})}),button2=i(375,475,"Clear",function(){game.state.start("submit")}),button3=i(650,475,"Menu",function(){game.state.start("menu")}),button1.scale.setTo(.3,.5),button2.scale.setTo(.3,.5),button3.scale.setTo(.3,.5),this.cKey=game.input.keyboard.addKey(Phaser.Keyboard.C),this.cKey.onDown.add(function(){o.setText(""),n.setText(""),r.setText("")},this)}},playConfig={preload:preload,create:create,update:update,render:render},RESOURCE_COLORS=[15539236,16646140,65441,16048773,3575691,2316169],CABLE_COLORS=[8421504,16777215,6539578,1783551,9835670,16755474],BGCOL=1118481,SHOP_WIDTH=200;Phaser.Game.prototype.gameResumed=function(e){this._paused&&!this._codePaused&&(this._paused=!1,paused?foreverTimers.forEach(function(e){e.resume()}):this.time.gameResumed(),this.input.reset(),this.sound.unsetMute(),this.onResume.dispatch(e))};var game=new Phaser.Game(config);game.state.add("boot",bootConfig),game.state.add("menu",menuConfig),game.state.add("tutorial",tutorialConfig),game.state.add("about",aboutConfig),game.state.add("game",playConfig),game.state.add("submit",submitConfig),game.state.start("boot");for(var gameGroup,nodes,packets,cables,slickUI,graphicsManager,worldGenerator,worldScale=.8,tutorialOn=!1,tutorialScreen=0,currentCredit=2e3,lifetimeCredit=0,currentPenalty=0,maxPenalty=500,packetCount=0,deadPackets=[],paused=!1,release=[],timers=[],speed=1,totalTime=0,currentCity=null,i=0;i<RESOURCE_COLORS.length;++i)deadPackets[i]=0;var cursors,foreverTimers=[];function initialisation(){currentCredit=2e3,currentPenalty=0,packetCount=0,lifetimeCredit=0,deadPackets=[],release=[],totalTime=0,timers=[],paused=!1,foreverTimers=[],speed=1,currentCity=null,tutorialOn=!1;for(var e=0;e<RESOURCE_COLORS.length;++e)deadPackets[e]=0;worldScale=.5}function preload(){slickUI.load("assets/ui/kenney/kenney.json")}WebFontConfig={active:function(){game.time.events.add(250,function(){game.state.start("menu",menuConfig)},this)},inactive:function(){game.state.start("menu",menuConfig)},google:{families:["Lato"]}};var statusPanel,nodeInfoPanel,shopPanel,STATUS_PANEL_WIDTH=200,STATUS_PANEL_HEIGHT=100,SHOP_PANEL_WIDTH=STATUS_PANEL_WIDTH,NODE_INFO_WIDTH=200,NODE_INFO_HEIGHT=165,CITY_INFO_HEIGHT=75,BUY_SERVER_WIDTH=200,BUY_SERVER_HEIGHT=50,BUY_CABLE_WIDTH=200,BUY_CABLE_HEIGHT=75,PANEL_WIDTH=200,PANEL_MARGIN=8,PANEL_LINE_DIST=10;function createPanels(){var e=(statusPanel=new StatusPanel(PANEL_MARGIN,PANEL_MARGIN,STATUS_PANEL_WIDTH,STATUS_PANEL_HEIGHT)).panel.y+STATUS_PANEL_HEIGHT+PANEL_MARGIN;game.height;nodeCityPanel=new NodeCityPanel(0,0,NODE_INFO_WIDTH,CITY_INFO_HEIGHT),nodeCityPanel.visible=!1,nodeInfoServerPanel=new NodeInfoServerPanel(0,0,NODE_INFO_WIDTH,NODE_INFO_HEIGHT+30),nodeInfoServerPanel.visible=!1,nodeResourcePanel=new NodeResourcePanel(0,0,BUY_CABLE_WIDTH,BUY_CABLE_HEIGHT),nodeResourcePanel.visible=!1,shopServerPanel=new ShopServerPanel(0,0,BUY_SERVER_WIDTH,BUY_SERVER_HEIGHT),shopServerPanel.visible=!1,shopCablePanel=new ShopCablePanel(0,0,BUY_CABLE_WIDTH,BUY_CABLE_HEIGHT),shopCablePanel.visible=!1}function create(){for(initialisation(),cursors=game.input.keyboard.createCursorKeys(),buttonPause=game.add.button(game.width-40,8,"buttonPause",function(){},this,1,0,1,0),buttonPause.onInputDown.add(function(){pause(),game.buttonPress=!0,buttonPause.visible=!1,buttonPlay.visible=!0},this),buttonPause.visible=!1,buttonPlay=game.add.button(game.width-40,8,"buttonPause",function(){},this,3,2,3,2),buttonPlay.onInputDown.add(function(){pause(),game.buttonPress=!0,buttonPause.visible=!0,buttonPlay.visible=!1},this),buttonSpeed1=game.add.button(game.width-40,47,"buttonSpeed",function(){},this,1,0,1,0),buttonSpeed1.onInputDown.add(function(){changeSpeed(2),game.buttonPress=!0,buttonSpeed1.visible=!1,buttonSpeed2.visible=!0}),buttonSpeed2=game.add.button(game.width-40,47,"buttonSpeed",function(){},this,3,2,3,2),buttonSpeed2.onInputDown.add(function(){changeSpeed(4),game.buttonPress=!0,buttonSpeed2.visible=!1,buttonSpeed4.visible=!0}),buttonSpeed2.visible=!1,buttonSpeed4=game.add.button(game.width-40,47,"buttonSpeed",function(){},this,5,4,5,4),buttonSpeed4.onInputDown.add(function(){changeSpeed(1),game.buttonPress=!0,buttonSpeed4.visible=!1,buttonSpeed1.visible=!0}),buttonSpeed4.visible=!1,buttonReload=game.add.button(game.width-40,86,"buttonReload",function(){},this,1,0,1,0),buttonReload.onInputDown.add(function(){game.state.start("menu")}),graphicsManager=new GraphicsManager,worldGenerator=new WorldGenerator,gameGroup=game.add.group(),cables=game.add.group(),tmpcables=game.add.group(),packets=game.add.group(),nodes=game.add.group(),ui=game.add.group(),ui.add(buttonPause),ui.add(buttonPlay),ui.add(buttonReload),ui.add(buttonSpeed1),ui.add(buttonSpeed2),ui.add(buttonSpeed4),gameGroup.add(cables),gameGroup.add(packets),gameGroup.add(nodes),gameGroup.position.setTo(game.world.centerX,game.world.centerY),game.input.mouse.capture=!0,this.tabKey=game.input.keyboard.addKey(Phaser.Keyboard.TAB),this.tabKey.onDown.add(moveToCity,this),this.plusKey=game.input.keyboard.addKey(Phaser.Keyboard.Q),this.minusKey=game.input.keyboard.addKey(Phaser.Keyboard.E),this.plusKey.onDown.add(function(){worldScale>.25&&(worldScale-=.05,gameGroup.scale.set(worldScale))},this),this.minusKey.onDown.add(function(){worldScale<1&&(worldScale+=.05,gameGroup.scale.set(worldScale))},this),this.wKey=game.input.keyboard.addKey(Phaser.Keyboard.W),this.aKey=game.input.keyboard.addKey(Phaser.Keyboard.A),this.sKey=game.input.keyboard.addKey(Phaser.Keyboard.S),this.dKey=game.input.keyboard.addKey(Phaser.Keyboard.D),game.input.mouse.mouseWheelCallback=function(e){var t=(gameGroup.x-game.input.activePointer.position.x)/worldScale,a=(gameGroup.y-game.input.activePointer.position.y)/worldScale;-1==game.input.mouse.wheelDelta?(.25!=worldScale&&(gameGroup.x-=.05*t,gameGroup.y-=.05*a),worldScale-=.05):(1!=worldScale&&(gameGroup.x+=.05*t,gameGroup.y+=.05*a),worldScale+=.05),worldScale=Phaser.Math.clamp(worldScale,.25,1),gameGroup.scale.set(worldScale)},game.stage.backgroundColor=1118481,game.clicked=!1,game.nodeclicked=!1,game.currentActivePanel=null,game.buttonPress=!1,game.cableMode=!1,game.cableDrag=!1,game.dragCable=null,game.nodeCurrentOver=null,network=new Network,graphicsManager.network=network,worldGenerator.initGameWorld(),i=0;null==currentCity;i++)network.nodes[i]instanceof City&&(currentCity=network.nodes[i]);createPanels(),graphicsManager.satisfactionBarInit(),graphicsManager.newCityTextInit(),gameGroup.scale.set(worldScale),pause()}function update(){if(updateCamera(),cursors.up.isDown||this.wKey.isDown?gameGroup.y+=8:(cursors.down.isDown||this.sKey.isDown)&&(gameGroup.y-=8),cursors.left.isDown||this.aKey.isDown?gameGroup.x+=8:(cursors.right.isDown||this.dKey.isDown)&&(gameGroup.x-=8),generalClickCheck(),game.cableDrag)if(game.dragCable.clear(),game.dragCable.alpha=1,game.dragCable.lineStyle(2,16777215,1),game.dragCable.moveTo(game.nodeclicked.x,game.nodeclicked.y),null!=game.nodeCurrentOver)game.dragCable.lineTo(game.nodeCurrentOver.x,game.nodeCurrentOver.y);else{var e=(game.input.activePointer.position.x-gameGroup.x)/worldScale,t=(game.input.activePointer.position.y-gameGroup.y)/worldScale;game.dragCable.lineTo(e,t)}else game.dragCable=null;if(!paused)for(totalTime+=game.time.elapsedMS*speed;timers.length>0&&timers[0].check();)removeTopTimer();null!=game.currentActivePanel&&game.currentActivePanel!=shopServerPanel&&game.currentActivePanel.setToNode(game.currentActivePanel.node),statusPanel.updateCredit(currentCredit);currentPenalty>=maxPenalty&&(lifetimeCredit>=2e4?confirm("Game over!\nWould you like to submit your score?")?game.state.start("submit"):game.state.start("menu"):(alert("Game over!\nYou have let too many packets die!\nNow returning to main menu."),game.state.start("menu")))}function pause(){paused?(paused=!1,game.time.gameResumed(),packets.forEach(function(e){e.tween.resume()}),release.forEach(function(e){e.releaseWaitingPool()}),release=[]):(paused=!0,game.time.gamePaused(),packets.forEach(function(e){e.tween.pause()}),foreverTimers.forEach(function(e){e.resume()}))}function updateCamera(){if(game.input.activePointer.isDown){if(game.origDragPoint&&!game.cableDrag){var e=game.origDragPoint.x-game.input.activePointer.position.x,t=game.origDragPoint.y-game.input.activePointer.position.y;Math.abs(e)+Math.abs(t)>2&&(game.drag=!0),gameGroup.x-=game.origDragPoint.x-game.input.activePointer.position.x,gameGroup.y-=game.origDragPoint.y-game.input.activePointer.position.y}game.origDragPoint=game.input.activePointer.position.clone()}else game.origDragPoint=null}function moveToCity(){for(var e=network.nodes.indexOf(currentCity);!(network.nodes[(e+1)%network.nodes.length]instanceof City);)e=(e+1)%network.nodes.length;currentCity=network.nodes[(e+1)%network.nodes.length],gameGroup.x-=gameGroup.worldPosition.x+currentCity.sprite.x*gameGroup.worldScale.x-game.width/2,gameGroup.y-=gameGroup.worldPosition.y+currentCity.sprite.y*gameGroup.worldScale.y-game.height/2}function render(){}function generalClickCheck(){if(game.input.activePointer.isDown&&(null==game.currentActivePanel?game.clicked=!0:game.buttonPress||game.cableMode||(game.currentActivePanel.visible=!1,game.currentActivePanel=null,shopServerPanel.nowUp=!0,game.cableMode=!1),game.nodeClicked&&!game.cableDrag&&null==game.currentActivePanel&&null!=game.nodeCurrentOver&&(game.cableDrag=!0,game.dragCable=game.add.graphics(),game.dragCable.lineStyle(2,16777215,1),game.dragCable.moveTo(game.nodeclicked.x,game.nodeclicked.y),game.dragCable.lineTo(game.nodeCurrentOver.x,game.nodeCurrentOver.y),cables.add(game.dragCable)),game.cableMode&&(game.clicked=!0),game.input.activePointer.duration>200&&(game.clicked=!1,shopServerPanel.nowUp=!1)),game.input.activePointer.isUp){if(game.cableDrag){if(game.dragCable.clear(),cables.remove(game.dragCable),game.dragCable=null,null!=game.nodeCurrentOver){var e=network.get_adjacent_cable(game.nodeclicked,game.nodeCurrentOver);if(network.can_connect(game.nodeclicked,game.nodeCurrentOver)||null!=e){var t=game.nodeclicked.dist(game.nodeCurrentOver),a=Math.floor((t/4+t*t/5e3)/1.5)+50,o=-1;if(null!=e&&(o=Math.floor(a*e.level*(1+e.level/3))),a<=currentCredit&&null==e)e=new Cable(network,game.nodeclicked,game.nodeCurrentOver,NEW_CABLE_LAMBDA,NEW_CABLE_V,1),currentCredit-=a,network.add_cable(e);else if(o<=currentCredit&&null!=e){currentCredit-=o,e.lambda-=.15,e.level+=1;var n=e.level;if(e.v+=50+4*Math.pow(Math.floor(n/2),2),network.update_distances(),n<=6)e.graphics.tint=CABLE_COLORS[n-1];else if(7==n){var r=game.time.create(!1);foreverTimers.push(r),e.timer=r.loop(100,function(t){t.version+=1,t.version==CABLE_COLORS.length&&(t.version=2);t.graphics.tint=CABLE_COLORS[e.version]},e,e),e.version=2,r.start()}else e.timer.delay=100/(n-6)}}}game.cableDrag=!1}game.clicked&&!game.buttonPress&&(null==game.nodeclicked||game.nodeclicked!=game.nodeCurrentOver||game.cableMode?game.cableMode?null!=game.currentActivePanel&&(game.cableMode=!1,game.currentActivePanel.visible=!1,game.currentActivePanel=null):game.drag||(shopServerPanel.nowUp=!shopServerPanel.nowUp,shopServerPanel.setToNode(null)):(game.buttonPress=!0,"server"==game.nodeclicked.type?nodeInfoServerPanel.setToNode(game.nodeclicked):"resource"==game.nodeclicked.type?nodeResourcePanel.setToNode(game.nodeclicked):nodeCityPanel.setToNode(game.nodeclicked)),shopCablePanel.visible=!1),game.drag=!1,game.buttonPress=!1,game.clicked=!1,game.nodeclicked=null,game.nodeClicked=!1}}function formatTime(e){var t=String(e%1e3);t.length<3&&(t="0".repeat(3-t.length)+t);var a=String(Math.floor(e/1e3)%60);return 1===a.length&&(a="0"+a),String(Math.floor(e/6e4))+":"+a+"."+t}function changeSpeed(e){speed=e,packets.forEach(function(e){e.tween.timeScale=speed})}